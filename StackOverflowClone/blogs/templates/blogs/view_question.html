{% extends 'home/index.html' %}
{% load static %}
{% block content %}
{% load crispy_forms_tags %}
<style>
    .up_voted{
        color: black;
    }
    .down_voted{
        color: #dbdbdb;
    }
    .tags{
        background-color: #07518f20;
        padding: 5px;
        border: 2px  #07518f20;
        border-radius: 5px;
        font-size: 11px;
        margin-right: 10px;
        color: #07518f;
    }
    #cke_id_body{
		width: auto !important;
	}
    .add_a_comment{
        font-size: 13px;
        cursor: pointer;
    }
    .add_a_comment:hover{
        color: #0d6efd;
    }
    .cmt_list{
        border-top: 1px solid silver;
        padding-bottom: 5px;
    }
</style>
    <div class="row" style="margin-bottom: 40px;">
        <div style="width: 5%; display:inline">
            <i id="up_vote_icon" style="cursor: pointer;" class="fas fa-long-arrow-alt-up {% if voted == 'up' %}up_voted{% else %}down_voted{% endif %}" onclick="VotePost(event,'{{ data.id }}', 'up')"></i><span id="vote_count">{{ vote_count }}</span><i id="down_vote_icon" style="cursor: pointer;" class="fas fa-long-arrow-alt-down {% if voted == 'down' %}up_voted{% else %}down_voted{% endif %}" onclick="VotePost(event, '{{ data.id }}', 'down')"></i>
        </div>
        <div style="width: 95%; display:inline;">
            <h4 class="main_title col-sm-9">{{data.title}}</h4>
            <p class="pt-3" style="font-size: 13px;">{{data.body | safe}}</p>
            {% for tag in data.tags.all %}
            <span class="tags">
                {{tag}}
            </span>
            {% endfor %}
            <div style="float: right;font-size: 10px;">
                {% if data.updated %}<span>edited &nbsp; {{data.updated}}</span><br>{% endif %}
                <span >created &nbsp; {{data.created}}</span><br>
                <i class="fa fa-user"></i>&nbsp; {{data.author.first_name}}&nbsp;{{data.author.last_name}}
            </div>
            <br>
            <br>
            {% if data.author.id == login_user_id %}
            <a href="{% url 'post_question' data.id %}" class="col-sm-1 text-light btn_style_2 center" style="background-color: green !important; border-color: green !important;">edit</a>
            <a href="{% url 'delete_question' data.id %}" class="col-sm-1 text-light btn_style_2 center" style="background-color: brown !important; border-color: brown !important;">delete</a>
            {% endif %}
            <br>
            <br>
            <div>
                {% for cmt_data in commnet_data %}
                <p class="cmt_list" id="id_cmt_{{cmt_data.id}}">{{cmt_data.body}}-<small> {{ cmt_data.author__first_name }}&nbsp;{{ cmt_data.author__last_name }}&nbsp;<span>({{ cmt_data.updated_at }})</span></small>&nbsp;&nbsp;
                    {% if cmt_data.author_id == login_user_id %}
                    <i class="bi bi-pencil-fill" style="font-size: 13px;cursor: pointer;" aria-hidden="true" onclick="EditCommnet('{{cmt_data.id}}')"></i>
                    {% endif %}
                </p>
                <div id="edit_comment_model_{{cmt_data.id}}" style="display: none;padding-top: 5px;border-top: 1px solid silver;" class="col-sm-12 col-md-12 col-lg-12">
                    <form style="display: flex;" method="POST" action="{% url 'add_comment' question_id 0 cmt_data.id %}">
                        {% csrf_token %}
                        <div style="width: 83%;margin-right: 5px;">
                        <textarea name="comment" cols="63" rows="3" style="max-height: 100px;font-size: 13px;padding: 5px;">{{cmt_data.body}}</textarea>
                        </div>
                        <div>
                            <button class="btn btn-primary center" type="submit" style="font-size: 13px;margin-bottom: 5px;">update comment</button>
                            <button class="btn btn-primary center" type="reset" onclick="EditCommnetCancel('{{cmt_data.id}}')" style="font-size: 13px;">cancel</button>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
            <span class="add_a_comment" onclick="addComment()">Add a comment</span>
            <div id="add_comment_model" style="display: none;" class="col-sm-12 col-md-12 col-lg-12">
                <form style="display: flex;" method="POST" action="{% url 'add_comment' question_id 0 0 %}">
                    {% csrf_token %}
                    <div style="width: 83%;">
                    <textarea name="comment" cols="64" rows="3" style="max-height: 100px;font-size: 13px;padding: 5px;"></textarea>
                    </div>
                    <div>
                    <button class="btn btn-primary center" type="submit" style="font-size: 13px;">Add comment</button></div>
                </form>
            </div>
            <!-- <a href="{% url 'answer_form' data.id 0 %}" class="col-sm-1 text-light btn_style_2 center" style="background-color: #0a95ff !important; border-color: #0a95ff !important;">Post your answer</a> -->
        </div>

    </div>
    <div class="row">
        <h6>{{total_answer}} &nbsp; Answer</h6>
        {% for data_ans in answer_data %}
        <div style="width: 95%; display:inline;border-bottom: 1px solid #c0c0c0;padding-bottom: 10px;">
            
            <div style="margin-left: 25px;">
                <!-- <h4 class="main_title col-sm-9">{{data}}</h4> -->
                
                    <p class="pt-3" style="font-size: 13px;">
                        {% if data.author.id == login_user_id %}
                            {% if data_ans.is_accepted %} 
                            <i class="fa fa-check fa-2x" id="answer_{{ data_ans.id }}" style="color: green; font-size: 2rem;cursor: pointer;" onclick="AcceptAnswer('{{ data_ans.id }}', true)"></i>
                            {% else %}
                            <i class="fa fa-check fa-2x" id="answer_{{ data_ans.id }}" style="color: #5555; font-size: 2rem;cursor: pointer;" onclick="AcceptAnswer('{{ data_ans.id }}', false)"></i>
                            {% endif %} 
                        {% endif %}
                        &nbsp; &nbsp; {{data_ans.body | safe}}
                    </p>
                

                <div style="float: right;font-size: 10px;">
                    <span>edited &nbsp; {{data_ans.updated_at}}</span><br>
                    <span >answered &nbsp; {{data_ans.created_at}}</span><br>
                    <i class="fa fa-user"></i>&nbsp; {{data_ans.author__first_name}}&nbsp;{{data_ans.author__last_name}}
                </div>
                {% if data_ans.author == login_user_id %}
                    <a href="{% url 'answer_form' data_ans.question data_ans.id %}" class="col-sm-1 text-light btn_style_2 center" style="background-color: green !important; border-color: green !important; margin-right: 10px;">Edit answer</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="container py-5">
        <h5>Post a answer:</h5>
        <form method="POST" action="{% url 'post_answer' question_id 0 %}">
            {% csrf_token %}
            {{ form|crispy }}  
            <br>
            <button class="btn btn-primary center" type="submit">Post answer</button>
            <button class="btn btn-primary center" type="submit">Save as a Draft</button>
        </form>
    </div>
    
    <p style="display: none;">{% csrf_token %}</p>
    <script>
        function VotePost(event, post_id, vote_type){
            event.stopPropagation();
            var postData = {
                "vote_type": vote_type,
            }
            $.ajax({
                dataType: "json",
                type: "POST",
                url: "/blogs/vote_question/" + post_id + '/',
                data: postData,
                success: function (data) {
                    if (data.code == 401){
                        window.location = "/login/";
                    }
                    if (data.code == 1) {
                        $("#vote_count").text(data.vote_count)
                        if (data.voted == true && vote_type == 'up'){
                            $("#up_vote_icon").removeClass("down_voted")
                            $("#up_vote_icon").addClass("up_voted")
                            $("#down_vote_icon").removeClass("up_voted")
                            $("#down_vote_icon").addClass("down_voted")
                        }
                        if (data.voted == false && vote_type == 'up') {
                            $("#up_vote_icon").removeClass("up_voted")
                            $("#up_vote_icon").addClass("down_voted")
                        }
                        if (data.voted == true && vote_type == 'down'){
                            $("#down_vote_icon").removeClass("down_voted")
                            $("#down_vote_icon").addClass("up_voted")
                            $("#up_vote_icon").removeClass("up_voted")
                            $("#up_vote_icon").addClass("down_voted")
                        }
                        if (data.voted == false && vote_type == 'down') {
                            $("#down_vote_icon").removeClass("up_voted")
                            $("#down_vote_icon").addClass("down_voted")
                        }
                    }
                    if (data.code == 0) {
                        showMessage(
                            "msg",
                            "danger",
                            data.msg,
                            5
                        );
                    }
                }
            });
        }

        function AcceptAnswer(answer_id, is_accepted){
            var question_id = '{{ question_id }}';
            var postData = {
                "question_id" : question_id,
                "answer_id" : answer_id,
                "is_accepted" : is_accepted,
                "csrfmiddlewaretoken": '{{ csrf_token }}',
            }
            $.ajax({
                dataType: "json",
                type: "POST",
                url: "/blogs/accept_answer/",
                data: postData,
                success: function (data) {
                    console.log("data", data);
                    if (data.code == 1 && is_accepted == true && data.old_answer_id == 0){
                        $("#answer_" + answer_id).css('color', '#5555')
                        $("#answer_" + answer_id).attr("onclick","AcceptAnswer(" + answer_id +", false)");
                    }
                    if (data.code == 1 && is_accepted == false){
                        $("#answer_" + answer_id).css('color', 'green')
                        $("#answer_" + data.old_answer_id).css('color', '#5555')
                        $("#answer_" + answer_id).attr("onclick","AcceptAnswer(" + answer_id +", true)");
                        $("#answer_" + data.old_answer_id).attr("onclick","AcceptAnswer(" + answer_id +", false)");
                    }
                    if (data.code == 0){
                        showMessage(
                            "msg",
                            "danger",
                            data.msg,
                            5
                        );
                    }
                }}
                )}
                
                function addComment() {
                    $("#add_comment_model").show();
                }
                
                function EditCommnet(comment_id){
                    console.log("comment_id", comment_id);
                    $("#id_cmt_"+comment_id).hide();
                    $("#edit_comment_model_"+comment_id).show();
                }

                function EditCommnetCancel(comment_id){
                    console.log("comment_id", comment_id);
                    $("#id_cmt_"+comment_id).show();
                    $("#edit_comment_model_"+comment_id).hide();
                }
    </script>
{% endblock %}