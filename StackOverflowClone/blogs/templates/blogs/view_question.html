{% extends 'home/index.html' %}
{% load static %}
{% block content %}
{% load crispy_forms_tags %}
{% load custom_tags %}
<style>
    .up_voted{
        color: black;
    }
    .down_voted{
        color: #dbdbdb;
    }
    .tags{
        background-color: #07518f20;
        padding: 5px;
        border: 2px  #07518f20;
        border-radius: 5px;
        font-size: 11px;
        margin-right: 10px;
        color: #07518f;
    }
    #cke_id_body{
		width: auto !important;
	}
    .add_a_comment{
        font-size: 13px;
        cursor: pointer;
    }
    .add_a_comment:hover{
        color: #0d6efd;
    }
    .cmt_list{
        border-top: 1px solid silver;
        padding-bottom: 5px;
    }
    #refresh_answer{
        display: none;
        cursor: pointer;
    }
    .answer {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        background-image: linear-gradient(45deg, #f1e5bc 0%, #c79999 100%);
    }

    .answer p {
        margin: 0;
    }

    .answer-link {
        color: blue;
        text-decoration: underline;
    }

    .answer-link:hover {
        color: darkblue;
    }
    #refresh_question{
        display: none;
        cursor: pointer;
    }
    .question {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        background-image: linear-gradient(45deg, #f1e5bc 0%, #c79999 100%);
    }

    .question p {
        margin: 0;
    }

    .question-link {
        color: blue;
        text-decoration: underline;
    }

    .question-link:hover {
        color: darkblue;
    }
    #chat_gpt_answer {
      display: inline-block;
      background-color: #4CAF50;
      border: none;
      color: white;
      text-align: center;
      font-size: 14px;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.3s ease;
      text-decoration: none;
      box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
    }
    
    #chat_gpt_answer:hover {
      background-color: #45a049;
    }
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      background-color: #f1f1f1;
      box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.3);
      z-index: 9999;
      border: 1px solid #ccc;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .popup-content {
      text-align: center;
      padding: 20px;
      position: relative;
      max-height: 600px; 
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      margin-top: -25px;
      margin-right: -15px;
    }
    
    .close:hover {
      color: black;
    }
    
    .popup:before {
      content: '';
      position: absolute;
      top: -15px;
      left: 50px;
      border-style: solid;
      border-width: 0 15px 15px 15px;
      border-color: transparent transparent #f1f1f1 transparent;
      transform: rotate(180deg);
    }
    .loader {
      border: 8px solid #0751a8;
      border-top: 8px solid #4CAF50;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      animation: spin 2s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .accept-button {
      display: inline-block;
      background-color: #4CAF50;
      border: none;
      color: white;
      text-align: center;
      font-size: 16px;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.3s ease;
      text-decoration: none;
      margin-top: 10px;
    }
    
    .accept-button:hover {
      background-color: #45a049;
    }
</style>
    <div class="row" style="margin-bottom: 40px;">
        <div style="width: 5%; display:inline">
            <i id="up_vote_icon" style="cursor: pointer;" class="fas fa-long-arrow-alt-up {% if voted == 'up' %}up_voted{% else %}down_voted{% endif %}" onclick="VotePost(event,'{{ data.id }}', 'up')"></i><span id="vote_count">{{ vote_count }}</span><i id="down_vote_icon" style="cursor: pointer;" class="fas fa-long-arrow-alt-down {% if voted == 'down' %}up_voted{% else %}down_voted{% endif %}" onclick="VotePost(event, '{{ data.id }}', 'down')"></i>
        </div>
        <div style="width: 95%; display:inline;">
            <h4 class="main_title col-sm-9">{{data.title}}</h4>
            <p class="pt-3" style="font-size: 13px;">{{data.body | safe}}</p>
            {% for tag in data.tags.all %}
            <span class="tags">
                {{tag}}
            </span>
            {% endfor %}
            <div style="float: right;font-size: 10px;">
                {% if data.updated %}<span>edited &nbsp; {{data.updated}}</span><br>{% endif %}
                <span >created &nbsp; {{data.created}}</span><br>
                <i class="fa fa-user"></i>&nbsp; {{data.author.first_name}}&nbsp;{{data.author.last_name}}
            </div>
            <br>
            <br>
            {% if data.author.id == login_user_id %}
            <a href="{% url 'post_question' data.id %}" class="col-sm-1 text-light btn_style_2 center" style="background-color: green !important; border-color: green !important;">edit</a>
            <a href="{% url 'delete_question' data.id %}" class="col-sm-1 text-light btn_style_2 center" style="background-color: brown !important; border-color: brown !important;">delete</a>
            {% endif %}
            <br>
            <br>
            <div>
                {% for cmt_data in qu_commnet_data %}
                <p class="cmt_list" id="id_cmt_{{cmt_data.id}}">{{cmt_data.body}}-<small> {{ cmt_data.author__first_name }}&nbsp;{{ cmt_data.author__last_name }}&nbsp;<span style="color: #0751a8;">- {{ cmt_data.updated_at | human_time }}</span></small>&nbsp;&nbsp;
                    {% if cmt_data.author_id == login_user_id %}
                    <i class="bi bi-pencil-fill" style="font-size: 13px;cursor: pointer;" aria-hidden="true" onclick="EditComment('{{cmt_data.id}}')"></i>
                    {% endif %}
                </p>
                <div id="edit_comment_model_{{cmt_data.id}}" style="display: none;padding-top: 5px;border-top: 1px solid silver;" class="col-sm-12 col-md-12 col-lg-12">
                    <form style="display: flex;" method="POST" action="{% url 'add_comment' question_id 0 cmt_data.id %}">
                        {% csrf_token %}
                        <div style="width: 83%;margin-right: 5px;">
                        <textarea name="comment" cols="63" rows="3" style="max-height: 100px;font-size: 13px;padding: 5px;">{{cmt_data.body}}</textarea>
                        </div>
                        <div>
                            <button class="btn btn-primary center" type="submit" style="font-size: 13px;margin-bottom: 5px;">update comment</button>
                            <button class="btn btn-primary center" type="reset" onclick="EditCommentCancel('{{cmt_data.id}}')" style="font-size: 13px;">cancel</button>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
            <div class="answer" id="refresh_answer" onclick="getAllAnswers()">
                <p>
                  Someone answered this Question 
                  click here to see!
                </p>
            </div>
            <div class="question" id="refresh_question" onclick="getQuestion()">
                <p>
                  Author has edited the question
                  click here to see updated version!
                </p>
            </div>
            <span class="add_a_comment" onclick="addComment()">Add a comment</span>
            <div id="add_comment_model" style="display: none;" class="col-sm-12 col-md-12 col-lg-12">
                <form style="display: flex;" method="POST" action="{% url 'add_comment' question_id 0 0 %}">
                    {% csrf_token %}
                    <div style="width: 83%;">
                    <textarea name="comment" cols="64" rows="3" style="max-height: 100px;font-size: 13px;padding: 5px;"></textarea>
                    </div>
                    <div>
                    <button class="btn btn-primary center" type="submit" style="font-size: 13px;">Add comment</button></div>
                </form>
            </div>
            <!-- <a href="{% url 'answer_form' data.id 0 %}" class="col-sm-1 text-light btn_style_2 center" style="background-color: #0a95ff !important; border-color: #0a95ff !important;">Post your answer</a> -->
        </div>

    </div>
    <a id="chat_gpt_answer" onclick="getChatGptAnswer('{{ data.id }}')">Click here to see what ChatGPT says about the question</a>
    <div id="popup" class="popup">
        <div class="popup-content">
          <span class="close" onclick="closePopup()">&times;</span>
          <p id="popup-content"></p>
          <button class="accept-button" onclick="acceptAnswer()">Accept this as an Answer(not implemented yet)</button>
        </div>
      </div>

    <div class="row" id="answers_div">
        <h6>{{total_answer}} &nbsp; Answers</h6>
        {% for data_ans in answer_data %}
        <div style="width: 95%; display:inline;border-bottom: 1px solid #c0c0c0;padding-bottom: 10px;">
            
            <div style="margin-left: 25px;">
                <!-- <h4 class="main_title col-sm-9">{{data}}</h4> -->
                
                    <p class="pt-3" style="font-size: 13px;">
                        {% if data.author.id == login_user_id %}
                            {% if data_ans.is_accepted %} 
                            <i class="fa fa-check fa-2x" id="answer_{{ data_ans.id }}" style="color: green; font-size: 2rem;cursor: pointer;" onclick="AcceptAnswer('{{ data_ans.id }}', true)"></i>
                            {% else %}
                            <i class="fa fa-check fa-2x" id="answer_{{ data_ans.id }}" style="color: #5555; font-size: 2rem;cursor: pointer;" onclick="AcceptAnswer('{{ data_ans.id }}', false)"></i>
                            {% endif %} 
                        {% endif %}
                        {% if data.author.id != login_user_id and data_ans.is_accepted %} 
                            <i class="fa fa-check fa-2x" id="answer_{{ data_ans.id }}" style="color: green; font-size: 2rem;"></i>
                        {% endif %}
                        &nbsp; &nbsp; {{data_ans.body | safe}}
                    </p>
                

                <div style="float: right;font-size: 10px;">
                    <span>edited &nbsp; {{data_ans.updated_at}}</span><br>
                    <span >answered &nbsp; {{data_ans.created_at}}</span><br>
                    <i class="fa fa-user"></i>&nbsp; {{data_ans.author__first_name}}&nbsp;{{data_ans.author__last_name}}
                </div>
                {% if data_ans.author == login_user_id %}
                    <a href="{% url 'answer_form' data_ans.question data_ans.id %}" class="col-sm-1 text-light btn_style_2 center" style="background-color: green !important; border-color: green !important; margin-right: 10px;">Edit answer</a>
                {% endif %}
                <br>
                <br>
                <div>
                    {% for ans_cmt_data in answer_comment_data %}
                        {% if ans_cmt_data.answer_id == data_ans.id %}
                            <p class="cmt_list" id="id_cmt_{{ans_cmt_data.id}}">{{ans_cmt_data.body}}-<small> {{ ans_cmt_data.author__first_name }}&nbsp;{{ ans_cmt_data.author__last_name }}&nbsp;<span style="color: #0751a8;">- {{ ans_cmt_data.updated_at | human_time }}</span></small>&nbsp;&nbsp;
                                {% if ans_cmt_data.author_id == login_user_id %}
                                <i class="bi bi-pencil-fill" style="font-size: 13px;cursor: pointer;" aria-hidden="true" onclick="EditComment('{{ans_cmt_data.id}}')"></i>
                                {% endif %}
                            </p>
                            <div id="edit_comment_model_{{ans_cmt_data.id}}" style="display: none;padding-top: 5px;border-top: 1px solid silver;" class="col-sm-12 col-md-12 col-lg-12">
                                <form style="display: flex;" method="POST" action="{% url 'add_comment' question_id 0 ans_cmt_data.id %}">
                                    {% csrf_token %}
                                    <div style="width: 83%;margin-right: 5px;">
                                    <textarea name="comment" cols="59" rows="3" style="max-height: 100px;font-size: 13px;padding: 5px;">{{ans_cmt_data.body}}</textarea>
                                    </div>
                                    <div>
                                        <button class="btn btn-primary center" type="submit" style="font-size: 13px;margin-bottom: 5px;">update comment</button>
                                        <button class="btn btn-primary center" type="reset" onclick="EditCommentCancel('{{ans_cmt_data.id}}')" style="font-size: 13px;">cancel</button>
                                    </div>
                                </form>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                <span class="add_a_comment" onclick="addAnsComment('{{data_ans.id}}')">Add a comment</span>
                <div id="add_ans_comment_model_{{data_ans.id}}" style="display: none;" class="col-sm-12 col-md-12 col-lg-12">
                    <form style="display: flex;" method="POST" action="{% url 'add_comment' question_id data_ans.id 0 %}">
                        {% csrf_token %}
                        <div style="width: 83%;">
                        <textarea name="comment" cols="60" rows="3" style="max-height: 100px;font-size: 13px;padding: 5px;"></textarea>
                        </div>
                        <div>
                        <button class="btn btn-primary center" type="submit" style="font-size: 13px;">Add comment</button></div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="container py-5">
        <h5>Post a answer:</h5>
        <form id="submit_answer" method="POST" action="{% url 'post_answer' question_id 0 %}">
            {% csrf_token %}
            {{ form|crispy }}  
            <br>
            <button class="btn btn-primary center" type="submit">Post answer</button>
            <button class="btn btn-primary center" type="submit">Save as a Draft</button>
        </form>
    </div>
    <p style="display: none;">{% csrf_token %}</p>
    <script>
        function VotePost(event, post_id, vote_type){
            event.stopPropagation();
            var postData = {
                "vote_type": vote_type,
            }
            $.ajax({
                dataType: "json",
                type: "POST",
                url: "/blogs/vote_question/" + post_id + '/',
                data: postData,
                success: function (data) {
                    if (data.code == 401){
                        window.location = "/login/";
                    }
                    if (data.code == 1) {
                        $("#vote_count").text(data.vote_count)
                        if (data.voted == true && vote_type == 'up'){
                            $("#up_vote_icon").removeClass("down_voted")
                            $("#up_vote_icon").addClass("up_voted")
                            $("#down_vote_icon").removeClass("up_voted")
                            $("#down_vote_icon").addClass("down_voted")
                        }
                        if (data.voted == false && vote_type == 'up') {
                            $("#up_vote_icon").removeClass("up_voted")
                            $("#up_vote_icon").addClass("down_voted")
                        }
                        if (data.voted == true && vote_type == 'down'){
                            $("#down_vote_icon").removeClass("down_voted")
                            $("#down_vote_icon").addClass("up_voted")
                            $("#up_vote_icon").removeClass("up_voted")
                            $("#up_vote_icon").addClass("down_voted")
                        }
                        if (data.voted == false && vote_type == 'down') {
                            $("#down_vote_icon").removeClass("up_voted")
                            $("#down_vote_icon").addClass("down_voted")
                        }
                    }
                    if (data.code == 0) {
                        showMessage(
                            "msg",
                            "danger",
                            data.msg,
                            5
                        );
                    }
                }
            });
        }

        function AcceptAnswer(answer_id, is_accepted){
            var question_id = '{{ question_id }}';
            var postData = {
                "question_id" : question_id,
                "answer_id" : answer_id,
                "is_accepted" : is_accepted,
                "csrfmiddlewaretoken": '{{ csrf_token }}',
            }
            $.ajax({
                dataType: "json",
                type: "POST",
                url: "/blogs/accept_answer/",
                data: postData,
                success: function (data) {
                    console.log("data", data);
                    if (data.code == 1 && is_accepted == true && data.old_answer_id == 0){
                        $("#answer_" + answer_id).css('color', '#5555')
                        $("#answer_" + answer_id).attr("onclick","AcceptAnswer(" + answer_id +", false)");
                    }
                    if (data.code == 1 && is_accepted == false){
                        $("#answer_" + answer_id).css('color', 'green')
                        $("#answer_" + data.old_answer_id).css('color', '#5555')
                        $("#answer_" + answer_id).attr("onclick","AcceptAnswer(" + answer_id +", true)");
                        $("#answer_" + data.old_answer_id).attr("onclick","AcceptAnswer(" + answer_id +", false)");
                    }
                    if (data.code == 0){
                        showMessage(
                            "msg",
                            "danger",
                            data.msg,
                            5
                        );
                    }
                }}
                )}
                
        function addComment() {
            $("#add_comment_model").show();
        }
        
        function EditComment(comment_id){
            $("#id_cmt_"+comment_id).hide();
            $("#edit_comment_model_"+comment_id).show();
        }

        function EditCommentCancel(comment_id){
            $("#id_cmt_"+comment_id).show();
            $("#edit_comment_model_"+comment_id).hide();
        }

        function addAnsComment(ans_id){
            $("#add_ans_comment_model_"+ans_id).show();
        }

        var question_socket = new WebSocket("ws://" + window.location.host + "/ws/question/" + '{{ question_id }}' + '/');
        question_socket.onopen = function (e) {
            console.log("Successfully connected to the question_socket.", question_socket);
        }
        $('#submit_answer').submit(function(){
            question_socket.send(JSON.stringify({
                'message': 'Submitted an answer', "user_id": '{{ request.user.id }}'
            }));

        })
        question_socket.onmessage = function (e) {
            message_data = JSON.parse(e.data)
            var user_id = parseInt(message_data.user_id)
            var logged_in_user_id = {{ request.user.id|default:"null" }};
            if (logged_in_user_id === user_id){
                return false
            }
            if ( message_data.message == 'Question has been edited')
                {
                    $("#refresh_question").css("display", 'block')
                }
            else
            {
                $("#refresh_answer").css("display", 'block')
            }}
            
        function getAllAnswers(){
            location.reload();
        }    
        function getQuestion(){
            location.reload();
        }

        function getChatGptAnswer(question_id) {
            document.getElementById("popup").style.display = "block";
            document.getElementById("popup-content").innerHTML = '<div class="loader"></div><p>Loading...</p>';
            var inputData = {
                'question_id': question_id,
            }
            $.ajax({
                dataType: "json",
                type: "POST",
                url: "/blogs/fetch_chatgpt_answer/",
                data: inputData,
                success: function (data) {
                    if (data.code == 1){
                        var chatGptResponse = data.response
                        document.getElementById("popup-content").innerHTML = chatGptResponse;
                    }
                    else{
                    document.getElementById("popup").style.display = "none";
                    }
                }})
        }
    
        function closePopup() {
            document.getElementById("popup").style.display = "none";
        }

    </script>
{% endblock %}